# 🧪 Supabase 同步功能测试指南

> 按照以下步骤测试 Supabase 多设备同步和冲突解决功能

## ✅ 准备工作

- [x] Supabase 迁移已运行
- [x] 认证功能已启用
- [x] 环境变量已配置

## 🚀 开始测试

### 步骤 1: 启动开发服务器

```bash
npm run dev
```

访问 http://localhost:5173

---

### 步骤 2: 打开同步测试面板

1. 打开应用后，点击底部导航栏的 **"设置"** 或 **"管理"** 标签
2. 在右上角找到 **同步图标** (🔄 RefreshCw icon)
3. 点击打开 **"同步功能测试"** 面板

![测试面板位置](位于餐厅管理页面右上角)

---

### 步骤 3: 注册/登录账户

#### 方式 1: 使用测试面板中的登录选项

在测试面板中，如果显示"未登录"：
1. 你需要先有一个账户
2. 可以在 Supabase Dashboard → Authentication → Users 中手动创建
3. 或使用下面的方式

#### 方式 2: 创建简单的登录页面（推荐）

为了方便测试，我已经创建了 `AuthScreen` 组件。你可以：

**临时测试方法**：
1. 打开浏览器开发者控制台
2. 运行以下代码注册新用户：

```javascript
// 在浏览器控制台运行
import { supabase } from './src/lib/supabase'

// 注册新用户
await supabase.auth.signUp({
  email: 'test@example.com',
  password: 'test123456'
})

// 登录
await supabase.auth.signInWithPassword({
  email: 'test@example.com',
  password: 'test123456'
})
```

**或者添加登录按钮到界面**：

在 `src/components/ManagementScreen.jsx` 临时添加一个登录按钮：

```jsx
// 在顶部导入
import { AuthScreen } from './AuthScreen.jsx'
import { supabase } from '../lib/supabase'

// 在组件内添加状态
const [showAuth, setShowAuth] = useState(false)
const [user, setUser] = useState(null)

// 检查用户状态
useEffect(() => {
  supabase.auth.getUser().then(({ data: { user } }) => {
    setUser(user)
  })
}, [])

// 在头部添加登录/退出按钮
{!user ? (
  <button onClick={() => setShowAuth(true)}>登录</button>
) : (
  <button onClick={() => supabase.auth.signOut()}>
    退出 ({user.email})
  </button>
)}

// 添加认证弹窗
{showAuth && (
  <div className="fixed inset-0 z-50">
    <AuthScreen onAuthSuccess={() => {
      setShowAuth(false)
      checkUser()
    }} />
  </div>
)}
```

---

### 步骤 4: 测试基础同步功能

#### 4.1 测试连接

1. 在同步测试面板中，点击 **"测试连接"** 按钮
2. 查看操作日志
3. ✅ 应该显示 "Supabase 连接正常"

#### 4.2 添加测试数据

1. 关闭同步测试面板
2. 在餐厅管理页面，添加几个餐厅：
   - 麦当劳 (等级: 夯)
   - 星巴克 (等级: 顶级)
   - 路边摊 (等级: NPC)

#### 4.3 同步到云端

1. 重新打开同步测试面板
2. 点击 **"完整同步"** 按钮
3. 等待同步完成
4. ✅ 应该显示 "同步成功"

#### 4.4 验证云端数据

1. 打开 [Supabase Dashboard](https://supabase.com/dashboard)
2. 进入你的项目
3. 点击 **Table Editor** → **restaurants**
4. ✅ 应该能看到你刚才添加的餐厅数据

---

### 步骤 5: 测试多设备同步

#### 5.1 准备第二个设备

打开另一个浏览器（或无痕模式），访问 http://localhost:5173

#### 5.2 在设备 2 登录

1. 使用相同的账户登录
2. 打开同步测试面板
3. 点击 **"完整同步"**
4. ✅ 应该能看到设备 1 上添加的餐厅

#### 5.3 双向同步测试

**在设备 2 上**：
1. 添加一个新餐厅：肯德基 (等级: 夯)
2. 点击 "完整同步"

**在设备 1 上**：
1. 点击 "完整同步"
2. ✅ 应该能看到 "肯德基"

---

### 步骤 6: 测试冲突解决 (核心功能)

#### 6.1 创建冲突

**在设备 1 上**（离线状态）：
1. 打开浏览器开发者工具 → Network → Offline（模拟离线）
2. 编辑 "麦当劳"，将等级改为 **"顶级"**
3. 保存

**在设备 2 上**（离线状态）：
1. 同样开启 Offline 模式
2. 编辑 "麦当劳"，将等级改为 **"拉完了"**
3. 保存

#### 6.2 触发冲突

**在设备 1 上**：
1. 关闭 Offline 模式（恢复在线）
2. 打开同步测试面板
3. 点击 "完整同步"
4. ✅ 应该显示 "同步成功"（因为是第一个同步的）

**在设备 2 上**：
1. 关闭 Offline 模式
2. 点击 "完整同步"
3. ⚠️ 应该显示 "发现 1 个冲突"

#### 6.3 解决冲突

1. 冲突解决界面应该自动弹出
2. 你会看到两个版本的对比：
   - **本地版本**（此设备）：等级 = "拉完了"
   - **云端版本**（其他设备）：等级 = "顶级"
3. 点击其中一个卡片进行选择
4. 点击 **"保留本地版本"** 或 **"保留云端版本"**
5. ✅ 冲突解决成功

#### 6.4 验证冲突解决结果

**在两个设备上**：
1. 都点击 "完整同步"
2. 查看 "麦当劳" 的等级
3. ✅ 两个设备应该显示相同的数据（你选择保留的版本）

---

### 步骤 7: 查看设备同步状态

#### 在 Supabase Dashboard 中：

1. **Table Editor** → **device_sync_metadata**
2. 你应该能看到两个设备的记录：
   - device_id（唯一标识）
   - device_name（可在测试面板中设置）
   - last_sync_at（最后同步时间）
   - sync_count（同步次数）
   - conflict_count（冲突次数）

3. **Table Editor** → **sync_conflicts**
4. 查看已解决的冲突记录
5. ✅ 应该能看到你刚才解决的冲突，`resolved_at` 字段有值

---

## 🎯 进阶测试场景

### 测试场景 1: 营养目标同步

1. 在设备 1 设置营养目标（如果你的应用有这个功能）
2. 同步到云端
3. 在设备 2 上同步
4. ✅ 验证营养目标已同步

### 测试场景 2: 营养日志同步

1. 添加一些营养记录
2. 测试跨设备同步
3. ✅ 验证所有日志都已同步

### 测试场景 3: 软删除

1. 在设备 1 删除一个餐厅
2. 同步
3. 在设备 2 同步
4. ✅ 餐厅应该也被删除（通过 deleted_at 字段标记）

---

## 🐛 故障排查

### 问题 1: 同步按钮点击无响应

**检查**：
- 是否已登录？（查看测试面板的"当前用户"部分）
- 浏览器控制台是否有错误？
- 网络是否正常？

### 问题 2: "❌ 连接失败" 错误

**检查**：
- `.env` 文件中的 `VITE_SUPABASE_URL` 和 `VITE_SUPABASE_ANON_KEY` 是否正确
- Supabase 项目是否正常运行
- 是否需要重启开发服务器（修改 .env 后）

### 问题 3: 冲突解决界面没有出现

**检查**：
- 打开浏览器控制台，查看是否有 JavaScript 错误
- 确认 `App.jsx` 中已正确导入 `SyncConflictResolver`
- 检查 `useSync` hook 的 `hasConflicts` 状态

### 问题 4: 数据没有同步

**检查**：
1. 打开 Supabase Dashboard → Table Editor → restaurants
2. 手动查看是否有数据
3. 检查 RLS 策略是否正确（auth.uid() = user_id）
4. 查看 Supabase Logs 获取详细错误信息

---

## 📊 测试检查清单

完成以下所有测试即代表同步功能正常：

- [ ] ✅ 注册/登录账户成功
- [ ] ✅ 测试连接成功
- [ ] ✅ 添加餐厅并同步到云端
- [ ] ✅ 在 Supabase Dashboard 看到数据
- [ ] ✅ 多设备登录同一账户
- [ ] ✅ 设备 A 的数据同步到设备 B
- [ ] ✅ 设备 B 的数据同步到设备 A
- [ ] ✅ 制造冲突（两个设备离线修改同一数据）
- [ ] ✅ 冲突解决界面正确显示
- [ ] ✅ 选择一个版本后冲突解决
- [ ] ✅ 两个设备最终数据一致
- [ ] ✅ 在 Supabase 中看到设备同步元数据
- [ ] ✅ 在 Supabase 中看到已解决的冲突记录

---

## 🎓 测试完成后

恭喜！你已经成功测试了：

1. ✅ **Supabase 认证** - 用户注册和登录
2. ✅ **数据库集成** - 数据保存到云端
3. ✅ **多设备同步** - 跨设备数据一致性
4. ✅ **冲突检测** - 自动发现数据冲突
5. ✅ **冲突解决** - 用户主导的冲突解决流程
6. ✅ **Row Level Security** - 用户只能访问自己的数据

---

## 📝 下一步

测试通过后，你可以：

1. **集成到生产环境**
   - 移除测试代码
   - 添加更友好的认证界面
   - 设置自动同步（应用启动时）

2. **优化用户体验**
   - 添加同步状态指示器
   - 后台自动同步（每15分钟）
   - 网络变化时自动同步

3. **添加更多功能**
   - 实时订阅（监听数据变化）
   - 设备管理（查看所有登录设备）
   - 同步历史记录

---

**需要帮助？**

- 查看 [完整架构文档](./doc/supabase-sync-architecture.md)
- 查看 [快速开始指南](./doc/supabase-quick-start.md)
- 检查浏览器控制台错误信息
- 查看 Supabase Dashboard 的 Logs 部分

---

**测试愉快！** 🎉
